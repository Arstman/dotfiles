#!/bin/sh
# Values are hardcoded for my current setup

mons=$(xrandr --current | grep ".* connected")

mons_count=$(echo "$mons" | wc -l)

# Connected monitors on a single line, delimited by spaces
mons=$(echo "$mons" | awk '{printf("%s ", $1)}')

d1=$(echo $mons | cut -d\  -f1)
d2=$(echo $mons | cut -d\  -f2)

if [ $mons_count -ge 2 ]; then
    if [ $# -lt 1 ]; then
	result=$(echo "d1\nd2\nboth\nmanual" | 
	    dmenu -r -i -p "Select output:" -l 10 )
    else
	result=$1
    fi

    if [ "$result" = "both" ]; then
	if [ $# -lt 2 ]; then
	    alignment=$(echo "left-of\nright-of\nabove\nbelow\nsame-as" |
		dmenu -r -i -p "d2 should be ... d1")
	else
	    alignment=$2
	fi
    fi

    # Always use highest available refresh rate on d2
    case "$result" in
	d1)       xrandr --output $d1 --auto --output $d2 --off
	          ;;
	d2)       xrandr --output $d1 --off --output $d2 --auto --rate 1000
	          ;;
	both)     xrandr --output $d1 --primary --auto --output $d2 --auto --rate 1000 --$alignment $d1
	          ;;
	manual)   arandr
	          ;;
    esac
else
    echo "OK" | dmenu -i -p "No external monitors found."
    xrandr --output $d1 --auto

    # Disable all disconnected monitors that still have an area associated with
    # them
    xrandr --listactivemonitors | tail -n +3 | awk '{print $4}' | while read mon; do
	xrandr --output $mon --off
    done
fi

[ $XDG_VTNR -eq 1 ] && setwallpaper &
